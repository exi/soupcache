<html>
<head>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js"></script>
</head>
<body>
pause with any <u>letter</u>, click on images for similarity search, <a href="http://www.parasoup.de">click here to visit soup</a>, currently: <u><span id="paused">unpaused</span></u>.
you are here for: <span id="time"></span> and watched <span id="items"></span> pictures;
<div id="container"></div>
<script type="text/javascript">
    var timer = null;
    var paused = false;
    var requestInProgress = false;
    var nodes = [];
    var maxEntries = 15;
    var items = 0;
    //var iframe = document.getElementById("iframe").contentWindow;
    //var urls = {};
    //var porn = {};
    //var pfilter = false;

    var continueLoop = function() {
        timer = setTimeout(ajaxLoop, 250);
    }

    var showImage = function(img, notimer) {
        img.slideDown(1000, function() {
            items++;
            if (!notimer) continueLoop();
        });
    }

    var hideImage = function(img) {
        img.slideUp(1000, function() {
        });
    }

    //var nudeCheckReceiver = function(result) {
    //    if (result && result.data) {
    //        var data = result.data;
    //        if (data.url && urls.hasOwnProperty(data.url)) {
    //            if (data.res === false) {
    //                showImage($(urls[data.url]));
    //            } else {
    //                console.log(data);
    //                porn[data.url] = urls[data.url];
    //                continueLoop();
    //                updateFilterButton();
    //            }
    //            delete urls[data.url];
    //        }
    //    }
    //}

    //window.addEventListener("message", nudeCheckReceiver, false);

    var ajaxLoop = function() {
        if (!paused && !requestInProgress) {
            requestInProgress = true;
            $.ajax({
                url: window.location + "newStuff",
                success: function(data, textStatus, xhr) {
                    if (xhr.status == 200 && !paused) {
                        while (nodes.length > maxEntries) {
                            //if (porn.hasOwnProperty($(nodes[0]).attr("src"))) delete porn[$(nodes[0]).attr("src")];
                            $(nodes[0]).remove();
                            nodes.splice(0, 1);
                        }
                        //updateFilterButton();
                        $("<img />")
                            .attr("src", data).
                            load(function() {
                                if (!paused) {
                                    $(this).hide().css('float', 'left');
                                    var a = $("<a />").
                                    attr("href", "http://images.google.com/searchbyimage?image_url=" + data).
                                    attr("target", "_blank").
                                    prepend(this);
                                    $('#container').prepend(a);
                                    nodes.push(this);
                                    //if (pfilter === true) {
                                    //    urls[data] = this;
                                    //    iframe.postMessage(data, "http://a.asset.parasoup.de:1234");
                                    //} else {
                                        showImage($(this));
                                    //}
                                }
                                requestInProgress = false;
                            })
                            .error(function() {
                                $(this).remove();
                                timer = setTimeout(ajaxLoop, 250);
                                requestInProgress = false;
                            });
                    } else if (paused) {
                        requestInProgress = false;
                    }
                },
                error: function(xhr, ajaxOptions, thrownError) {
                    console.error(xhr);
                    console.error(thrownError);
                    requestInProgress = false;
                    setTimeout(ajaxLoop, 1000);
                }
            });
        }
    }

    var keyEvents = function() {
        $(document).keypress(function(evt) {
            if (evt.which >= 97 && evt.which <= 122) {
                if (paused) {
                    paused = false;
                    ajaxLoop();
                    $('#paused').text("unpaused");
                } else {
                    paused = true;
                    if (timer) clearTimeout(timer);
                    timer = null;
                    $('#paused').text("paused");
                }
            } else console.log(evt);
        });
    }

    var printStatus = function() {
        var start = new Date();
        var timeNode = $('#time');
        var itemNode = $('#items');
        setInterval(function() {
            var diff = ((new Date()) - start) / 1000;
            var hours = 0,
                minutes = 0,
                seconds = 0;
            hours = Math.floor(diff/(60*60));
            diff %= (60*60);
            minutes = Math.floor(diff/60);
            diff %= (60);
            seconds = Math.floor(diff);

            var text = "";
            if (hours > 0) text += hours + " hours ";
            if (minutes > 0 || hours > 0) text += minutes + " minutes ";
            if (seconds > 0 || minutes > 0 || hours > 0) text += seconds + " seconds";

            timeNode.text(text);

            itemNode.text(items);

            document.title = text + ", " + items + " pictures";
        }, 1000);
    }

    //var updateFilterButton = function() {
    //    if (pfilter === true) {
    //        var hidden = Object.keys(porn).length
    //        $("#porn").text("don't hide Porn (" + hidden + " hidden)");
    //    } else {
    //        $("#porn").text("try to hide porn");
    //    }
    //}

    //var registerFilter = function() {
    //    $("#porn").click(function() {
    //        if (pfilter === true) {
    //            pfilter = false;
    //            for (var i in porn) if (porn.hasOwnProperty(i)) showImage($(porn[i]));

    //        } else {
    //            pfilter = true;
    //            for (var i in porn) if (porn.hasOwnProperty(i)) hideImage($(porn[i]));
    //        }
    //        updateFilterButton();
    //    });
    //    updateFilterButton();
    //}

    $(function() {
        ajaxLoop();
        keyEvents();
        printStatus();
        //registerFilter();
    });
</script>
</body>
</html>
