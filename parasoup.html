<html>
<head>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js"></script>
</head>
<body>
pause with any <u>letter</u>, currently: <span id="paused">unpaused</span>. you are here for: <span id="time"></span>
<div id="container"></div>
<script type="text/javascript">
    var timer = null;
    var paused = false;
    var requestInProgress = false;
    var nodes = [];
    var maxEntries = 15;

    var ajaxLoop = function() {
        if (!paused && !requestInProgress) {
            requestInProgress = true;
            $.ajax({
                url: "http://parasoup.soup.wthack.de:1234/newStuff",
                success: function(data, textStatus, xhr) {
                    if (xhr.status == 200 && !paused) {
                        while (nodes.length > maxEntries) {
                            $(nodes[0]).remove();
                            nodes.splice(0, 1);
                        }
                        $("<img />")
                            .attr("src", data).
                            load(function() {
                                $(this).hide().css('float', 'left');
                                $('#container').prepend(this);
                                nodes.push(this);
                                $(this).slideDown(1000, function() {
                                    timer = setTimeout(ajaxLoop, 250);
                                });
                                requestInProgress = false;
                            })
                            .error(function() {
                                $(this).remove();
                                timer = setTimeout(ajaxLoop, 250);
                                requestInProgress = false;
                            });
                    } else if (paused) {
                        requestInProgress = false;
                    }
                },
                error: function(xhr, ajaxOptions, thrownError) {
                    console.error(xhr);
                    console.error(thrownError);
                    requestInProgress = false;
                    setTimeout(ajaxLoop, 1000);
                }
            });
        }
    }

    var keyEvents = function() {
        $(document).keypress(function(evt) {
            if (evt.which >= 97 && evt.which <= 122) {
                if (paused) {
                    paused = false;
                    ajaxLoop();
                    $('#paused').text("unpaused");
                } else {
                    paused = true;
                    if (timer) clearTimeout(timer);
                    timer = null;
                    $('#paused').text("paused");
                }
            } else console.log(evt);
        });
    }

    var printTime = function() {
        var start = new Date();
        var node = $('#time');
        setInterval(function() {
            var diff = ((new Date()) - start) / 1000;
            var hours = 0,
                minutes = 0,
                seconds = 0;
            hours = Math.floor(diff/(60*60));
            diff %= (60*60);
            minutes = Math.floor(diff/60);
            diff %= (60);
            seconds = Math.floor(diff);

            var text = "";
            if (hours > 0) text += hours + " hours ";
            if (minutes > 0 || hours > 0) text += minutes + " minutes ";
            if (seconds > 0 || minutes > 0 || hours > 0) text += seconds + " seconds.";
            node.text(text);
        }, 1000);
    }
    $(
    function() {
        ajaxLoop();
        keyEvents();
        printTime();
    }
    );
</script>
</body>
</html>
