<html>
<head>
    <title>Infinite pictures scolling by</title>
    <meta name="description" content="Infinite pictures scrolling by">
    <meta name="keywords" content="soup.io, parasoup, funny pictures, scrolling">
    <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
    <style type="text/css">
        #slider { width: 250px; float: left; margin-right: 10px;}
        #toggler { width: 100%; height: 5px; z-index: 10; background-color: grey; }
        #effect { padding: 0.4em; position: relative; height: 100px; width: 100%; position: absolute; top: 0px; left: 0px; }
        #effect h3 { margin: 0; padding: 0.4em; text-align: center; }
    </style>
</head>
<body style="margin: 0;">
<div id="toggler">
<div id="effect" class="ui-widget-content ui-corner-all">
    <h3 class="ui-widget-header ui-corner-all">Parasoup</h3>
    <p>
    <div id="slider"></div>
    picture delay: <span id="delay"></span>, pause with any key,click image for search, <a href="http://www.parasoup.de">click here for soup</a>, <u><span id="paused">unpaused</span></u>.
    here for: <span id="time"></span>, watched <span id="items"></span> pictures
    </p>
</div>
</div>
<div id="container"></div>
<script type="text/javascript">
    var Cache = function() {
        this.name = "default";
        this.constructor = function(cacheSize) {
            this._cacheSize = cacheSize || 10;
            this._store = [];
            this._requestInProgress = false;
            this.update();
        }
    };
    Cache.prototype.update = function() {
        if (this._store.length < this._cacheSize) {
            this._fetch();
        }
    };
    Cache.prototype._fetch = function() {
        if (this._requestInProgress === false) {
            this._requestInProgress = true;
            this.fetch();
        }
    };
    Cache.prototype._fetchDone = function() {
        console.log(this.name + " store status: " + this.length() + "/" + this._cacheSize);
        this._requestInProgress = false;
        this.update();
    };
    Cache.prototype.add = function(item) {
        this._store.push(item);
    }
    Cache.prototype.fetch = function() {};
    Cache.prototype.get = function() {
        if (this._store.length > 0) {
            var ret = this._store.shift();
            this.update();
            return ret;
        } else {
            return null;
        }
    };
    Cache.prototype.length = function() {
        return this._store.length;
    };

    var UrlCache = function() {
        this.name = "url";
        this.fetch = function() {
            var that = this;
            $.ajax({
                url: "http://" + window.location.hostname + "/newStuff?",
                success: function(data, textStatus, xhr) {
                    if (xhr.status == 200) {
                        that.add(data);
                        that._fetchDone();
                    }
                },
                error: function(xhr, ajaxOptions, thrownError) {
                    console.error(xhr);
                    console.error(thrownError);
                    setTimeout(function() {that.fetch()}, 1000);
                }
            });
        }
    }

    UrlCache.prototype = new Cache();

    var ImgCache = function() {
        this.name = "img";
        this.urlCache = new UrlCache();
        this.urlCache.constructor();
        this.fetch = function() {
            var that = this;
            var retry = function() {
                setTimeout(function() {that.fetch();}, 1000);
            }
            var url = this.urlCache.get();
            if (url !== null) {
                $("<img />").
                    attr("src", url).
                    load(function() {
                        $(this).hide().css('float', 'left');
                        var a = $("<a />").
                            attr("href", "http://images.google.com/searchbyimage?image_url=" + url).
                            attr("target", "_blank").
                            prepend(this);
                        that.add(a);
                        that._fetchDone();
                    }).
                    error(function() {
                        $(this).remove();
                        retry();
                    });
            } else {
                retry();
            }
        }
    }

    ImgCache.prototype = new Cache();

    var imgCache = new ImgCache();
    imgCache.constructor();

    var timer = null;
    var paused = false;
    var nodes = [];
    var maxEntries = 15;
    var items = 0;
    var delay = 2000;

    var continueLoop = function() {
        timer = setTimeout(loop, delay);
    }

    var getImgFromA = function(a) { return $(a).children(":first"); };

    var showImage = function(img) {
        img.slideDown(1000, function() {
            items++;
            if (!paused) continueLoop();
        });
    }

    var loop = function() {
        if (!paused) {
            showNextImage();
        }
    }

    var showNextImage = function() {
        while (nodes.length > maxEntries) {
            $(nodes[0]).remove();
            nodes.splice(0, 1);
        }

        var a = imgCache.get();
        if (a !== null) {
            var img = getImgFromA(a);
            $('#container').prepend(a);
            nodes.push($(a));
            showImage($(img));
        } else if (!paused) {
            continueLoop();
        }
    }

    var invalidKeys = [18/*tab*/, 32, 33, 34, 35, 36, 38, 144];
    var nextKeys = [39/*right*/, 40/*down*/, 74/*j*/, 76/*l*/];
    //f1...f12
    for (var i = 112; i <= 123; i++) {
        invalidKeys.push(i);
    }

    var keyEvents = function() {
        var keyHandler = function(evt) {
            var key = evt.which || evt.keyCode;
            console.log(nextKeys.indexOf(key) + " " + key);
            if (invalidKeys.indexOf(key) === -1) {
                if (nextKeys.indexOf(key) !== -1) {
                    console.log("nextimage");
                    showNextImage();
                } else if (paused) {
                    paused = false;
                    loop();
                    $('#paused').text("unpaused");
                } else {
                    paused = true;
                    if (timer) clearTimeout(timer);
                    timer = null;
                    $('#paused').text("paused");
                }
            } else console.log("ignore key: " + key);
        }
        $(document).keydown(keyHandler);
    }

    var printStatus = function() {
        var start = new Date();
        var timeNode = $('#time');
        var itemNode = $('#items');
        setInterval(function() {
            var diff = ((new Date()) - start) / 1000;
            var hours = 0,
                minutes = 0,
                seconds = 0;
            hours = Math.floor(diff/(60*60));
            diff %= (60*60);
            minutes = Math.floor(diff/60);
            diff %= (60);
            seconds = Math.floor(diff);

            var text = "";
            if (hours > 0) text += hours + " hours ";
            if (minutes > 0 || hours > 0) text += minutes + " minutes ";
            if (seconds > 0 || minutes > 0 || hours > 0) text += seconds + " seconds";

            timeNode.text(text);

            itemNode.text(items);

            document.title = "parasoup.de: " + text + ", " + items + " pictures";
        }, 1000);
    }

    var updateDelay = function() {
        $("#delay").text(delay+ "ms")
    }

    $(function() {
        $("#slider").slider({
            value: 2000,
            min: 1000,
            max: 10000,
            slide: function(event, ui) {
                delay = ui.value;
                updateDelay();
            }
        });
        updateDelay();
        loop();
        keyEvents();
        printStatus();
        var hideTimer = null;
        var showing = false;
        $("#toggler").mouseenter(function() {
            clearTimeout(hideTimer);
            if (!showing) {
                showing = true;
                $("#effect").show("blind", 500, function() {
                    showing = false;
                });
            }
        });
        $("#effect").mouseover(function() {
            clearTimeout(hideTimer);
        });
        $("#effect").mouseout(function() {
            clearTimeout(hideTimer);
            hideTimer = setTimeout(function() {
                $("#effect").hide("blind", 500);
            }, 1000);
        });
        $("#effect").hide();
    });
</script>
</body>
</html>
